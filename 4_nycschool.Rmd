--- 
title: "Analysing perceptions of NYC schools"
author: "Uni Lee"
date: "12/13/2020"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(janitor)
library(dplyr)
library(corrplot)
library(tidyr)
library(ggcorrplot)
```
# Introduction

In this guided project, we will answer the following research questions by analyzing 4 datasets on demographic and test scores from the [New York City Department of Education](https://www.schools.nyc.gov). 


* Do student, teacher, and parent perceptions of NYC school quality appear to be related to demographic and academic success metrics?
* Do students, teachers, and parents have similar perceptions of NYC school quality?

# Data

The NYC Department of Education surveys all parents, teachers and students in grades 6-12 to assess  the community's opinions on academic expectations, communication, engagement, and safety and respect. The survey results can be downloaded [here](https://data.cityofnewyork.us/Education/2011-NYC-School-Survey/mnz3-dyi8). 

We will also use a combined dataset that we cleaned during the Dataquest mission. This dataset contains information on each school and academic performance. The data can be downloaded [here](https://data.world/dataquest/nyc-schools-data/workspace/file?filename=combined.csv).

```{r}
# Survey data for "general education" schools
gened_raw<- read_excel("data/4_nycschool/masterfile11_gened_final.xlsx", sheet=1, na="NA", skip=2) %>% clean_names()

# Survey data for "special education" schools (district 75)
sped_raw <- read_excel("data/4_nycschool/masterfile11_d75_final.xlsx", sheet=1, na="NA", skip=2) %>% clean_names()

# Cleaned and combined dataset on academic performance of NYC schools
combined_raw <- read.csv("data/4_nycschool/combined.csv") %>% clean_names
```

## Processing data

Variables related to the research questions are:
* Information on school (dbn, school_name)
* School demographics 
 + Percentage of black, asian, hispanic and white students (ends with "_per")
 
* academic success metrics
 + average sat scores (avg_sat_score)

* Perception of school quality by parents (p), students (s) and teachers (t). We will create a new variable that gives composite scores of the following sub-scores.
 + Safety and Respect scores (starts with "saf")
 + Communication scores (starts with "com")
 + Engagement scores (starts with "eng")
 + Academic expectations ("starts with "aca")

```{r}
# Create a new variable for composite scores for perception of the quality of education 
gened_raw <- gened_raw %>% mutate(
        perqual_p = (saf_p_11 + com_p_11 + eng_p_11 + aca_p_11)/4, na.rm=TRUE,
        perqual_s = (saf_s_11 + com_s_11 + eng_s_11 + aca_s_11)/4, na.rm=TRUE,
        perqual_t = (saf_t_11 + com_t_11 + eng_t_11 + aca_t_11)/4, na.rm=TRUE) %>%
        mutate(perqual = (perqual_p + perqual_s + perqual_t)/3, na.rm=TRUE)
sped_raw <- gened_raw %>%  mutate(
        perqual_p = (saf_p_11 + com_p_11 + eng_p_11 + aca_p_11)/4, na.rm=TRUE,
        perqual_s = (saf_s_11 + com_s_11 + eng_s_11 + aca_s_11)/4, na.rm=TRUE,
        perqual_t = (saf_t_11 + com_t_11 + eng_t_11 + aca_t_11)/4, na.rm=TRUE)%>%
        mutate(perqual = (perqual_p + perqual_s + perqual_t)/3, na.rm=TRUE)

# Select variables necessary for analysis. 
gened <- gened_raw %>% select(dbn, perqual)
sped <- sped_raw %>%  select(dbn, perqual)
combined <- combined_raw %>% select(dbn, school_name, avg_sat_score, ends_with("_per"), - male_per, -female_per) 

# Combine the general education and District 75 survey dataframes and school information.
survey <- bind_rows(gened, sped) 
# Used "left_join" function in order to retain data on schools that have both demographic information and perception of quality. 
survey_all <- left_join(combined, unique(survey), by="dbn") %>% select(dbn, school_name, avg_sat_score, perqual, white_per, asian_per, hispanic_per, black_per)

```

### Missing Data

In order to measure relationship among variables, we must treat missing values before proceeding to analysis.

```{r}
# How many missing values?
sapply(survey_all, function(x) sum(is.na(x)))

# What kind of schools are missing SAT scores?

# Impute missing SAT scores with average scores
sat_avg <- mean(survey_all$avg_sat_score, na.rm=TRUE)
survey_all$avg_sat_score <- replace_na(survey_all$avg_sat_score, sat_avg)

# Drop schools that do not have demographic data
survey_complete <- survey_all %>% drop_na()
colSums(is.na(survey_complete))
```


# Analysis
## Do student, teacher, and parent perceptions of NYC school quality appear to be related to demographic and academic success metrics?

To answer this question, we can calculate Pearson correlation coefficient for relevant variables. This statistic measures linear correlation between two variables. We can also visualize correlations among variables using corrplot function from dplyr package.

```{r}
# Compute Pearson's correlation coefficient
cor <- round(cor(survey_complete[,3:8]),2)

# Visualize correlations
ggcorrplot(cor, method="circle")

```
The correlation analysis suggests that academic performance (avg_sat_score) is *positively* correlated with the following variables:

* Perceived quality of education
* Percentage of white students and Asian students

Academic performance indicator is *negatively* correlated with the following variables:

* Percentage of black and hispanic students

The correlation coefficients also suggest that the more hispanic and black students the school has, the lower the perceived quality of education is. 


